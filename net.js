
//<![CDATA[

// a few things don't have var in front of them - they update already existing variables the game needs
lanesSide = 0;
patchesAhead = 1;
patchesBehind = 0;
trainIterations = 20000;

var num_inputs = (lanesSide * 2 + 1) * (patchesAhead + patchesBehind);
var num_actions = 5;
var temporal_window = 3;
var network_size = num_inputs * temporal_window + num_actions * temporal_window + num_inputs;

var layer_defs = [];
layer_defs.push({
    type: 'input',
    out_sx: 1,
    out_sy: 1,
    out_depth: network_size
});
layer_defs.push({
    type: 'fc',
    num_neurons: 16,
    activation: 'relu'
});
layer_defs.push({
    type: 'regression',
    num_neurons: num_actions
});

var tdtrainer_options = {
    learning_rate: 0.001,
    method: 'adadelta',
    eps: 1e-6, 
    ro:0.95,
    batch_size: 64,
    l1_decay: 0.1,
    l2_decay: 0.1
};

var opt = {};
opt.temporal_window = temporal_window;
opt.experience_size = 3000;
opt.start_learn_threshold = 500;
opt.gamma = 0.9;
opt.learning_steps_total = 10000;
opt.learning_steps_burnin = 1000;
opt.epsilon_min = 0;
opt.epsilon_test_time = 0;
opt.layer_defs = layer_defs;
opt.tdtrainer_options = tdtrainer_options;

brain = new deepqlearn.Brain(num_inputs, num_actions, opt);

learn = function (state, lastReward) {
    brain.backward(lastReward);
    var action = brain.forward(state);

    draw_net();
    draw_stats();

    return action;
}

//]]>
    
/*###########*/
if (brain) {
brain.value_net.fromJSON({"layers":[{"out_depth":19,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":16,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":19,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":19,"w":{"0":0.18034961281685113,"1":-0.03515468834709339,"2":0.13121477596156925,"3":-0.5442234698252404,"4":0.027168354159763073,"5":0.6155799887424125,"6":0.28218046420276455,"7":-0.06918880136449673,"8":0.23310467231284018,"9":0.4082282791024996,"10":-0.1930570747685034,"11":0.10726926024890668,"12":0.18267196410963674,"13":-0.1046354866460039,"14":0.07306122937679087,"15":0.4323304758189615,"16":-0.09240998188051909,"17":0.04115729878382643,"18":0.052304806176693086}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.7171957255096111,"1":0.5785426959161122,"2":0.173084141706648,"3":0.2225057018608647,"4":0.008393145990107433,"5":0.23311629553366442,"6":0.36045689894814154,"7":0.5148484757870202,"8":0.363357247053147,"9":0.11336107985638127,"10":0.017438228848584644,"11":0.24793371669987146,"12":0.17951886217639776,"13":0.4087099115039463,"14":0.28122117645912714,"15":0.14058221098129553,"16":0.002490740833608348,"17":0.14523658404377415,"18":0.2760669558793037}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.05872304229524605,"1":0.02501030691799043,"2":0.05114312875410272,"3":0.032267993643855734,"4":0.032153768000089504,"5":-0.051023508580029686,"6":0.24597082152741853,"7":-0.020445658789061634,"8":0.16679208642121685,"9":-0.20943436270542917,"10":0.07609249877659698,"11":-0.14371899067214217,"12":0.041236611077639214,"13":0.01832975853996608,"14":0.027567556959259772,"15":0.01201872120488745,"16":-0.013689249736331925,"17":0.15294386691355258,"18":0.02328528477895772}},{"sx":1,"sy":1,"depth":19,"w":{"0":-0.02282348213190144,"1":-0.023331245678445217,"2":0.06460887295895432,"3":-0.019007686305751354,"4":0.018962197416095734,"5":-0.1776173492641549,"6":0.06804677882208976,"7":-0.021061785598986096,"8":-0.022419704374199635,"9":-0.13604224487532693,"10":0.09151083209064692,"11":-0.056799598266341164,"12":0.042728867491447504,"13":-0.024106657719295693,"14":0.03335209151539783,"15":-0.1166244969107352,"16":0.06072746974350443,"17":-0.004884840733126221,"18":-0.048819219060737246}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.006832246706521868,"1":-0.041448571655523805,"2":-0.04218404959936362,"3":0.17062597701890636,"4":0.04029764408133851,"5":-0.2572258072377576,"6":0.14864067380324775,"7":-0.04717246909070031,"8":0.1731452515897039,"9":0.03673153242009214,"10":0.01913388112942324,"11":0.04130886034525478,"12":-0.2887827475902956,"13":-0.027336171897735517,"14":-0.04657642504215958,"15":0.3306930583291539,"16":-0.03960400743245066,"17":0.18781622440179038,"18":-0.15013501223032147}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.40726913294029127,"1":0.49395712019853427,"2":0.16390298347149063,"3":0.14613865830529332,"4":0.015154429406113144,"5":0.35804443407914127,"6":0.2169722519289107,"7":0.5182688993841483,"8":0.330182936860213,"9":0.30871190043588764,"10":-0.002904525991622811,"11":0.25737167425309854,"12":0.12277200423298973,"13":0.2093057854725066,"14":0.26911933504959856,"15":0.1344974871688637,"16":0.0024156344291319915,"17":0.3565462947986442,"18":0.12776862719146959}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.6959373835147005,"1":0.5335409606689387,"2":0.1607886682515768,"3":0.5466522198856144,"4":-0.0682478990194741,"5":0.263991110758921,"6":0.35716544947822776,"7":0.3863362369025008,"8":0.2397952684525155,"9":0.2615853499160417,"10":-0.11152200250015878,"11":0.2875286977360797,"12":0.48692555277259514,"13":0.43875702296304486,"14":0.21943407214349275,"15":0.4172887568399011,"16":-0.011130382733507667,"17":0.1253460007273559,"18":0.29187854085082693}},{"sx":1,"sy":1,"depth":19,"w":{"0":1.1314784109571079,"1":1.0355407296124723,"2":0.24991522092042956,"3":0.6394391429001228,"4":-0.018722461260456482,"5":0.37788034519860003,"6":0.3941244740528012,"7":1.0079568846001759,"8":0.3842879434131914,"9":0.5574905419507084,"10":0.008153729734428156,"11":0.5253884321584956,"12":0.3987785525436106,"13":0.7566261738746318,"14":0.3883073771008678,"15":0.36379813795024707,"16":0.050922204576972094,"17":0.28954131683085726,"18":0.337059122503785}},{"sx":1,"sy":1,"depth":19,"w":{"0":-0.036958233815799726,"1":0.03249658062008156,"2":0.027629382811068203,"3":0.25010775583666967,"4":-0.009412343305412024,"5":-0.014167821037205834,"6":-0.10135592102111414,"7":-0.109648654897208,"8":-0.020424727107296967,"9":-0.025417516534993145,"10":0.038553038003967546,"11":-0.019627766262641413,"12":0.16570176490805494,"13":-0.19054386013676905,"14":0.09291135295942964,"15":-0.20342463845385877,"16":0.06044216596848961,"17":0.035966693526563946,"18":-0.08557148777153586}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.4855632503655453,"1":0.36944834375689267,"2":0.1913009724372691,"3":0.5039613107903662,"4":-0.07719837541355723,"5":0.49270444461040885,"6":0.05348426343090878,"7":0.6251503008980083,"8":0.057377245531442904,"9":0.3921769436262245,"10":-0.12965181333445414,"11":0.2879714029847543,"12":0.40287242148224384,"13":0.17314561977239387,"14":0.20646251595532625,"15":0.20090077854198113,"16":0.021385279069691076,"17":0.20700338307680866,"18":0.1863154123493911}},{"sx":1,"sy":1,"depth":19,"w":{"0":-0.001996424793429313,"1":-0.0017004712594268433,"2":0.014443072445768094,"3":-0.36291372135413336,"4":0.0789815682015815,"5":-0.2697545338980841,"6":0.2890445816204016,"7":-0.03236981826806641,"8":0.3305720510375136,"9":-0.031241823459828,"10":-0.08014661832342845,"11":0.340280626097525,"12":-0.34701554404013213,"13":-0.00045650275254539526,"14":0.019007139059480038,"15":0.08811380324980968,"16":-0.05799320126950052,"17":0.11875372167999232,"18":0.036660094859231024}},{"sx":1,"sy":1,"depth":19,"w":{"0":-0.030220984357688378,"1":-0.029650891896176375,"2":0.050383681770572016,"3":-0.1885227073950038,"4":0.08809614122487372,"5":0.26637560904913393,"6":-0.27378817827233604,"7":-0.028618355017804343,"8":0.30390968826992093,"9":-0.20581047755181478,"10":0.058892258588554354,"11":-0.13285009658650032,"12":0.13763746333672477,"13":-0.03628523156990301,"14":0.10807574222360167,"15":-0.12674445852220984,"16":0.004152794131275948,"17":0.14810145901251467,"18":-0.11819367710244694}},{"sx":1,"sy":1,"depth":19,"w":{"0":-0.0450315602222854,"1":-0.05320040240868444,"2":0.02649700476341221,"3":-0.18183856680647853,"4":0.001449922460558642,"5":0.29479270605169977,"6":-0.16527448469143788,"7":-0.08588531759112185,"8":0.0023933912355280124,"9":-0.15997242283446583,"10":0.008294560019412584,"11":0.02442219010092093,"12":0.25660342904596367,"13":-0.21869175408545008,"14":-0.0002913158433531822,"15":-0.1334871127348381,"16":-0.000867199391732559,"17":0.32073895398475355,"18":-0.12219115245477023}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.23693970969856049,"1":0.22611426040759555,"2":0.08178719033203835,"3":-0.10977434111631346,"4":0.09418800355400989,"5":-0.054086521565521496,"6":0.22982253904071048,"7":0.16074121426866883,"8":0.27014861254379235,"9":0.01330940080857352,"10":0.09681447013390569,"11":-0.10131754591591072,"12":-0.05430883329986287,"13":-0.024350956759827416,"14":0.13284239486348584,"15":0.0399235041175832,"16":-0.03284059217110145,"17":0.18593243896556305,"18":0.0320482761684469}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.029404777320216867,"1":0.024279648069184038,"2":0.06044878242040823,"3":0.017512614957435196,"4":-0.023172017829173327,"5":0.15418008561208008,"6":-0.20264302717045918,"7":0.0029355766105706883,"8":-0.05159130925129223,"9":0.17586307451610894,"10":-0.01457904553185047,"11":0.10032690804662636,"12":-0.14252251867575313,"13":-0.04763867576545671,"14":0.04929860217002196,"15":-0.025348818527603078,"16":0.016464635868466016,"17":-0.059813770474723076,"18":0.0606910230655385}},{"sx":1,"sy":1,"depth":19,"w":{"0":0.07788195659628588,"1":0.03640427961872271,"2":0.10820500775222146,"3":0.007824954718169555,"4":0.03629703043422765,"5":-0.2745072963172343,"6":0.3544276080875334,"7":-0.006475761611973208,"8":-0.10455955610376491,"9":-0.28792038130052944,"10":0.09438656875476634,"11":0.11239241491616465,"12":0.152914092987296,"13":0.020307407931893808,"14":0.05746510797629157,"15":-0.11293055701650967,"16":0.04109772227211071,"17":0.22228385281744564,"18":0.06673997048441101}}],"biases":{"sx":1,"sy":1,"depth":16,"w":{"0":0.14434704715064137,"1":1.4349751231323813,"2":0.09493972480285419,"3":0.1064174878707114,"4":0.030601524122756733,"5":1.041366049462206,"6":1.1484294980848269,"7":1.918401483984029,"8":0.1550278678158673,"9":1.0762504831291577,"10":-0.006264098577223574,"11":0.12133470284604461,"12":-0.06715198763195948,"13":0.5550905352597224,"14":0.017427430159456147,"15":0.11294525858247659}}},{"out_depth":16,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":16,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":16,"w":{"0":0.05519434840250098,"1":0.6163697478790897,"2":0.059665209148423284,"3":-0.019763629203845116,"4":0.13298634124949799,"5":0.5004017468097247,"6":0.9910186102998569,"7":1.21132710443022,"8":0.07965865574762211,"9":0.9458833790792722,"10":-0.055848172261226105,"11":-0.056715023169438536,"12":0.03928207321919104,"13":0.19799394029555287,"14":-0.036033949376699265,"15":0.1878446260325815}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.603697242806261,"1":0.9183788468937061,"2":0.26698878735298665,"3":-0.21308345622838815,"4":0.3427469237018367,"5":0.7987116994176588,"6":0.7249653052976001,"7":1.3304120760826386,"8":0.026747523511393458,"9":0.35639416702302074,"10":0.4947015193871463,"11":0.5734703689873035,"12":0.4499798830034327,"13":0.5905227244995028,"14":-0.20648013026420237,"15":0.08008710132037221}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.3203581365668246,"1":0.6687134352491239,"2":-0.050053687453617754,"3":-0.11065750768583851,"4":0.028735526754626314,"5":0.5262503388796306,"6":1.0359572632325984,"7":1.040006631903475,"8":0.024465317126390888,"9":0.8158618799070543,"10":0.03889140967063729,"11":-0.11062814748948924,"12":-0.02315088268306957,"13":0.0034892547893628505,"14":0.05782395910151355,"15":-0.09204187379160664}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.3131225965337704,"1":0.8928856613940396,"2":0.18544587943644156,"3":0.042800797969488616,"4":-0.019237585873221205,"5":0.6275181332113985,"6":0.8933020029074041,"7":1.2802721660057863,"8":0.29005458087852476,"9":0.6154682912861366,"10":0.41665167856725577,"11":-0.05541675621118487,"12":-0.03552913001479557,"13":0.2822296285482278,"14":0.016071939254472898,"15":0.40456673483395394}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.6555549362687776,"1":0.724157790904497,"2":0.0021147873373402624,"3":0.020060663362908487,"4":-0.3691000040085591,"5":0.8293036689365736,"6":0.639591688568605,"7":1.363208174326486,"8":0.08608662667731982,"9":0.8370764628870587,"10":-0.3200820928498342,"11":0.1066710775120022,"12":0.3413161757201407,"13":0.22194659527360572,"14":0.22758947050477524,"15":-0.07050353618913312}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":0.6552711477423069,"1":0.7173868732472084,"2":0.7290156551279151,"3":0.7542234123883307,"4":0.5705618851251391}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":5}]});
}